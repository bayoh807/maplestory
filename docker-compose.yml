services:
  # MariaDB (MySQL å…¼å®¹ï¼ŒåŸç”Ÿæ”¯æ´ ARM64)
  # mysql:
  #   image: mariadb:10.11
  #   container_name: maplestory_db
  #   environment:
  #     MYSQL_ROOT_PASSWORD: root
  #     MYSQL_DATABASE: maplestory
  #     MYSQL_USER: maple
  #     MYSQL_PASSWORD: maple123
  #   volumes:
  #     - mysql_data:/var/lib/mysql
  #     - ./sql:/docker-entrypoint-initdb.d
  #   ports:
  #     - "3306:3306"
  #   restart: unless-stopped
  #   command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
  mysql:
    image: mysql:5.7
    platform: linux/amd64
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: maplestory
      MYSQL_USER: maple
      MYSQL_PASSWORD: maple123
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    restart: unless-stopped
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # MapleStory éŠæˆ²æœå‹™å™¨
  maplestory:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: maplestory_server
    depends_on:
      - mysql
    ports:
      - "8484:8484"
      - "8586:8586"
      - "8588:8588"
      - "8587:8587"
      - "8596:8596"
#    volumes:
#      - ./Logs:/maplestory/logs
#      - ./scripts:/maplestory/scripts
      # - ./wz:/maplestory/wz
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=maplestory
      - DB_USER=maple
      - DB_PASSWORD=maple123
    restart: unless-stopped
    # command: |
    #   sh -c '
    #     echo "=== MapleStory v113 Server å•Ÿå‹• ==="
        
    #     # æª¢æŸ¥ä¸¦å‰µå»º server.jar
    #     if [ -f "dist/TMS113.jar" ]; then
    #       cp dist/TMS113.jar server.jar
    #     elif [ -f "TMS113.jar" ]; then
    #       cp TMS113.jar server.jar
    #     elif [ ! -f "server.jar" ]; then
    #       echo "âŒ æ‰¾ä¸åˆ° server.jar æˆ– TMS113.jar"
    #       exit 1
    #     fi
        
    #     # æ›´æ–° Settings.ini
    #     if [ -f Settings.ini ]; then
    #       sed -i "s/localhost/mysql/g" Settings.ini
    #     fi
        
    #     echo "ç­‰å¾… MySQL å°±ç·’..."
    #     while ! nc -z mysql 3306; do sleep 1; done
    #     echo "âœ… MySQL é€£æ¥æˆåŠŸ!"
        
    #     echo "ğŸš€ å•Ÿå‹• MapleStory æœå‹™å™¨..."
    #     java -server -Xmx1024m -Xms512m -cp "server.jar:lib/*:." server.Start
    #   '
    command: |
      sh -c '
        echo "=== MapleStory v113 Server å•Ÿå‹• ==="

        # æª¢æŸ¥ä¸¦å‰µå»º server.jar
        if [ -f "dist/TMS113.jar" ]; then
          cp dist/TMS113.jar server.jar
        elif [ -f "TMS113.jar" ]; then
          cp TMS113.jar server.jar
        elif [ ! -f "server.jar" ]; then
          echo "âŒ æ‰¾ä¸åˆ° server.jar æˆ– TMS113.jar"
          exit 1
        fi

        # æ›´æ–° Settings.ini
        if [ -f Settings.ini ]; then
          sed -i "s/localhost/mysql/g" Settings.ini
        fi

        # ç­‰å¾… MySQL å®Œå…¨å¯ç”¨
        until mysql -h mysql -u maple -pmaple123 -e "SELECT 1" maplestory; do
          echo "MySQL é‚„æ²’æº–å‚™å¥½ï¼Œç­‰å¾… 2 ç§’..."
          sleep 2
        done
        echo "âœ… MySQL å·²å¯ç”¨"
        # å•Ÿå‹• MapleStory
        echo "ğŸš€ å•Ÿå‹• MapleStory æœå‹™å™¨..."
        java -server -Xmx1024m -Xms512m -cp "/maplestory/server.jar:/maplestory/JarLib/*" -Dnet.sf.odinms.wzpath=wz server.Start

      '


  # Adminer (phpMyAdmin çš„è¼•é‡æ›¿ä»£å“ï¼ŒåŸç”Ÿæ”¯æ´ ARM64)
#  adminer:
#    image: adminer:4.8.1
#    container_name: maplestory_adminer
#    depends_on:
#      - mysql
#    ports:
#      - "8080:8080"
#    restart: unless-stopped
#    environment:
#      ADMINER_DEFAULT_SERVER: mysql

volumes:
  mysql_data:
