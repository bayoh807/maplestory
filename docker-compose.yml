services:
  # MariaDB (MySQL 兼容，原生支援 ARM64)
  # mysql:
  #   image: mariadb:10.11
  #   container_name: maplestory_db
  #   environment:
  #     MYSQL_ROOT_PASSWORD: root
  #     MYSQL_DATABASE: maplestory
  #     MYSQL_USER: maple
  #     MYSQL_PASSWORD: maple123
  #   volumes:
  #     - mysql_data:/var/lib/mysql
  #     - ./sql:/docker-entrypoint-initdb.d
  #   ports:
  #     - "3306:3306"
  #   restart: unless-stopped
  #   command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
  mysql:
    image: mysql:5.7
    platform: linux/amd64
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: maplestory
      MYSQL_USER: maple
      MYSQL_PASSWORD: maple123
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "3306:3306"
    restart: unless-stopped
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # MapleStory 遊戲服務器
  maplestory:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: maplestory_server
    depends_on:
      - mysql
    ports:
      - "8484:8484"
      - "8586:8586"
      - "8588:8588"
      - "8587:8587"
      - "8596:8596"
#    volumes:
#      - ./Logs:/maplestory/logs
#      - ./scripts:/maplestory/scripts
      # - ./wz:/maplestory/wz
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=maplestory
      - DB_USER=maple
      - DB_PASSWORD=maple123
    restart: unless-stopped
    # command: |
    #   sh -c '
    #     echo "=== MapleStory v113 Server 啟動 ==="
        
    #     # 檢查並創建 server.jar
    #     if [ -f "dist/TMS113.jar" ]; then
    #       cp dist/TMS113.jar server.jar
    #     elif [ -f "TMS113.jar" ]; then
    #       cp TMS113.jar server.jar
    #     elif [ ! -f "server.jar" ]; then
    #       echo "❌ 找不到 server.jar 或 TMS113.jar"
    #       exit 1
    #     fi
        
    #     # 更新 Settings.ini
    #     if [ -f Settings.ini ]; then
    #       sed -i "s/localhost/mysql/g" Settings.ini
    #     fi
        
    #     echo "等待 MySQL 就緒..."
    #     while ! nc -z mysql 3306; do sleep 1; done
    #     echo "✅ MySQL 連接成功!"
        
    #     echo "🚀 啟動 MapleStory 服務器..."
    #     java -server -Xmx1024m -Xms512m -cp "server.jar:lib/*:." server.Start
    #   '
    command: |
      sh -c '
        echo "=== MapleStory v113 Server 啟動 ==="

        # 檢查並創建 server.jar
        if [ -f "dist/TMS113.jar" ]; then
          cp dist/TMS113.jar server.jar
        elif [ -f "TMS113.jar" ]; then
          cp TMS113.jar server.jar
        elif [ ! -f "server.jar" ]; then
          echo "❌ 找不到 server.jar 或 TMS113.jar"
          exit 1
        fi

        # 更新 Settings.ini
        if [ -f Settings.ini ]; then
          sed -i "s/localhost/mysql/g" Settings.ini
        fi

        # 等待 MySQL 完全可用
        until mysql -h mysql -u maple -pmaple123 -e "SELECT 1" maplestory; do
          echo "MySQL 還沒準備好，等待 2 秒..."
          sleep 2
        done
        echo "✅ MySQL 已可用"
        # 啟動 MapleStory
        echo "🚀 啟動 MapleStory 服務器..."
        java -server -Xmx1024m -Xms512m -cp "/maplestory/server.jar:/maplestory/JarLib/*" -Dnet.sf.odinms.wzpath=wz server.Start

      '


  # Adminer (phpMyAdmin 的輕量替代品，原生支援 ARM64)
#  adminer:
#    image: adminer:4.8.1
#    container_name: maplestory_adminer
#    depends_on:
#      - mysql
#    ports:
#      - "8080:8080"
#    restart: unless-stopped
#    environment:
#      ADMINER_DEFAULT_SERVER: mysql

volumes:
  mysql_data:
